

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums used across documents and movements
enum DocumentStatus {
  DRAFT
  WAITING
  READY
  DONE
  CANCELED
}

enum MovementType {
  TRANSFER
  RECEIPT
  DELIVERY
  ADJUSTMENT
}

enum MovementStatus {
  DRAFT
  DONE
  CANCELED
}

model User {
  id           Int       @id @default(autoincrement())
  loginId      String    @unique
  email        String    @unique
  name         String?
  passwordHash String
  // relations
  receipts     Receipt[] @relation("CreatedReceipts")
  deliveries   Delivery[]
  movements    Movement[]
  stockLogs    StockLedger[]
  stockAdjustments StockAdjustment[]
  otps         PasswordResetOtp[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model PasswordResetOtp {
  id        String   @id @default(uuid())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  otp       String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  @@index([userId])
}

model Category {
  id        String    @id @default(uuid())
  name      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
}

model Product {
  id           String         @id @default(uuid())
  name         String
  sku          String         @unique
  unit         String
  reorderLevel Int            @default(0)
  categoryId   String?
  category     Category?      @relation(fields: [categoryId], references: [id])
  stocks       Stock[]
  receiptItems ReceiptItem[]
  deliveryItems DeliveryItem[]
  movements    Movement[]
  ledger       StockLedger[]
  stockAdjustments StockAdjustment[]
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model Warehouse {
  id        String     @id @default(uuid())
  name      String
  code      String?    @unique
  address   String?
  locations Location[]
  createdAt DateTime   @default(now())
}

model Location {
  id          String    @id @default(uuid())
  name        String
  code        String?   // optional code for racks/shelves
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  stocks      Stock[]
  movesFrom   Movement[] @relation("FromLocation")
  movesTo     Movement[] @relation("ToLocation")
  stockLedgers StockLedger[]
  stockAdjustments StockAdjustment[]
  createdAt   DateTime  @default(now())
  @@index([warehouseId])
}

model Stock {
  id         String   @id @default(uuid())
  productId  String
  product    Product  @relation(fields: [productId], references: [id])
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  quantity   Int      @default(0)
  reserved   Int      @default(0)
  updatedAt  DateTime @updatedAt
  @@unique([productId, locationId])
  @@index([productId])
  @@index([locationId])
}

model Receipt {
  id          String        @id @default(uuid())
  supplier    String?
  status      DocumentStatus @default(DRAFT)
  createdById Int
  createdBy   User          @relation("CreatedReceipts", fields: [createdById], references: [id])
  items       ReceiptItem[]
  expectedAt  DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model ReceiptItem {
  id        String  @id @default(uuid())
  receiptId String
  receipt   Receipt @relation(fields: [receiptId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  unitPrice Float?
}

model Delivery {
  id         String         @id @default(uuid())
  customer   String?
  status     DocumentStatus @default(DRAFT)
  createdById Int?
  createdBy  User?          @relation(fields: [createdById], references: [id])
  items      DeliveryItem[]
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
}

model DeliveryItem {
  id         String   @id @default(uuid())
  deliveryId String
  delivery   Delivery @relation(fields: [deliveryId], references: [id])
  productId  String
  product    Product  @relation(fields: [productId], references: [id])
  quantity   Int
}

model Movement {
  id             String         @id @default(uuid())
  productId      String
  product        Product        @relation(fields: [productId], references: [id])
  fromLocationId String?
  fromLocation   Location?      @relation("FromLocation", fields: [fromLocationId], references: [id])
  toLocationId   String?
  toLocation     Location?      @relation("ToLocation", fields: [toLocationId], references: [id])
  quantity       Int
  type           MovementType
  status         MovementStatus @default(DONE)
  referenceId    String?         // optional: reference to receipt/delivery/ad-hoc id
  createdById    Int?
  createdBy      User?           @relation(fields: [createdById], references: [id])
  createdAt      DateTime        @default(now())
}

// Ledger of all stock changes (immutable audit log)
model StockLedger {
  id         String   @id @default(uuid())
  productId  String
  product    Product  @relation(fields: [productId], references: [id])
  locationId String?  // null when change is not location-specific
  location   Location? @relation(fields: [locationId], references: [id])
  change     Int
  reason     String?  // human readable reason or short code
  reference  String?  // reference id (receipt, delivery, movement)
  userId     Int?     // who performed the change
  user       User?    @relation(fields: [userId], references: [id])
  createdAt  DateTime @default(now())
  @@index([productId])
  @@index([locationId])
}

model StockAdjustment {
  id           String   @id @default(uuid())
  productId    String
  product      Product  @relation(fields: [productId], references: [id])
  locationId   String
  location     Location @relation(fields: [locationId], references: [id])
  countedQty   Int
  recordedQty  Int
  difference   Int
  reason       String?
  createdById  Int?
  createdBy    User?    @relation(fields: [createdById], references: [id])
  createdAt    DateTime @default(now())
}

// @@map("prisma_metadata")










